# 言語マッチングサービス - 全体計画書

## プロジェクト概要

### サービス名（仮）
**LangMatch** / **TalkNow** / **InstantLang**

### ビジョン
「時間が確定された、真剣な会話」を提供する言語マッチングサービス

### ミッション
- メッセージ不要・アプリ不要・即会話できる
- カレンダーで即アポ確定
- 冷やかし防止のため課金必須

---

## 開発戦略

### MVP（最小実行可能製品）の定義

#### 必須機能
1. ✅ ユーザー登録・プロフィール管理
2. ✅ Google Calendar連携
3. ✅ 基本的なマッチング機能（言語・レベル・時間帯）
4. ✅ アポイントメント確定
5. ✅ Google Meet自動生成
6. ✅ ポイント購入（Stripe）
7. ✅ ポイント消費（アポ確定時）
8. ✅ 通知（Email必須、WhatsApp任意）

#### 初期は人力で対応可能な機能
- マッチング提案（自動化前は手動確認）
- ドタキャン対応（手動対応）
- カスタマーサポート

#### 後回しにする機能
- AIによるマッチング最適化
- 自動リマインド
- 詳細な分析ダッシュボード
- モバイルアプリ

---

## 開発フェーズ詳細

### Phase 0: 準備・設計（2週間）

#### 目標
- 開発に必要な設計・環境を整える
- 外部API申請を開始

#### 主要タスク

**Week 1: 設計**
- [ ] ユーザーストーリー作成（10-15個）
- [ ] データモデル設計（ER図作成）
- [ ] API設計（エンドポイント一覧）
- [ ] UI/UXワイヤーフレーム（Figma推奨）
- [ ] セキュリティ要件定義

**Week 2: 環境構築**
- [ ] GitHubリポジトリ作成
- [ ] Next.jsプロジェクト初期化
- [ ] データベース環境構築（Supabase/Neon）
- [ ] CI/CD設定（GitHub Actions）
- [ ] 開発環境ドキュメント作成

**外部API申請（並行して実施）**
- [ ] Google Cloud Console設定
  - Calendar API有効化
  - OAuth 2.0設定
- [ ] Stripeアカウント作成
  - テスト環境設定
- [ ] Twilioアカウント作成
  - WhatsApp Business API申請開始（審査に時間かかる）
- [ ] SendGridアカウント作成

#### 成果物
- 設計書一式
- 開発環境
- API申請状況

---

### Phase 1: MVP（6-8週間）

#### 目標
動作する最小機能を実装し、実際にユーザーが使える状態にする

#### Week 1-2: 基盤構築

**データベース**
- [ ] Supabase/Neonプロジェクト作成
- [ ] テーブル作成（users, appointments, point_transactions, matching_history）
- [ ] マイグレーション設定
- [ ] 初期データ投入（テスト用）

**認証**
- [ ] NextAuth.js設定
- [ ] Google OAuth統合
- [ ] セッション管理
- [ ] 認証ミドルウェア

**基本API**
- [ ] ユーザーCRUD API
- [ ] 認証API
- [ ] エラーハンドリング
- [ ] バリデーション

#### Week 3-4: ユーザー管理

**フロントエンド**
- [ ] サインアップ/サインインページ
- [ ] プロフィール編集ページ
- [ ] 言語・レベル選択UI
- [ ] カレンダー連携ボタン

**Google Calendar連携**
- [ ] OAuth認証フロー
- [ ] カレンダーID取得・保存
- [ ] Freebusy API統合（空き時間取得）
- [ ] カレンダー同期機能

#### Week 5-6: マッチング機能

**マッチングロジック**
- [ ] マッチングアルゴリズム実装
  - 言語マッチ（学びたい言語 × 教えられる言語）
  - レベルマッチ（中級以上 × ネイティブ等）
  - 時間帯マッチ（共通の空き時間）
- [ ] マッチング候補取得API
- [ ] マッチング提案API

**アポイントメント**
- [ ] アポイントメント確定API
- [ ] Google Calendarイベント作成
- [ ] Google Meetリンク自動生成
- [ ] アポイントメント一覧表示

**UI**
- [ ] マッチング候補表示ページ
- [ ] アポイントメント詳細ページ
- [ ] カレンダー表示

#### Week 7-8: 決済・通知

**Stripe統合**
- [ ] Stripe Checkout実装
- [ ] サブスクリプション設定
- [ ] Webhook処理（決済完了・失敗）
- [ ] ポイント付与ロジック

**ポイントシステム**
- [ ] ポイント残高管理
- [ ] ポイント消費（アポ確定時）
- [ ] ポイント返却（キャンセル時）
- [ ] 取引履歴表示

**通知**
- [ ] SendGrid統合（Email）
- [ ] 通知テンプレート作成
  - マッチング通知
  - アポ確定通知
  - リマインド（後で自動化）
  - キャンセル通知
- [ ] Twilio統合（WhatsApp、審査通過後）

#### Week 9-10: 統合・テスト

**テスト**
- [ ] 単体テスト（主要ロジック）
- [ ] 統合テスト（API）
- [ ] E2Eテスト（主要フロー）
- [ ] 手動テスト（全機能）

**バグ修正・調整**
- [ ] パフォーマンス最適化
- [ ] エラーハンドリング改善
- [ ] UI/UX改善

**デプロイ**
- [ ] ステージング環境デプロイ
- [ ] 本番環境デプロイ準備
- [ ] ドメイン設定

#### 成果物
- 動作するMVP
- テストユーザーで動作確認可能な状態

---

### Phase 2: 自動化・改善（4-6週間）

#### 目標
人力オペレーションを減らし、自動化を進める

#### Week 1-2: マッチング最適化

**AI統合**
- [ ] OpenAI/Gemini API統合
- [ ] マッチング優先度スコアリング
  - 言語マッチ度
  - レベル適合度
  - 時間帯適合度
  - 信頼度スコア

**信頼度システム**
- [ ] ドタキャン履歴管理
- [ ] 信頼度スコア計算
- [ ] ペナルティシステム
- [ ] マッチング優先度への反映

#### Week 3-4: 通知・リマインド

**自動リマインド**
- [ ] スケジューラー実装（Cron Job / Vercel Cron）
- [ ] 24時間前リマインド
- [ ] 1時間前リマインド
- [ ] リマインド通知送信

**自動キャンセル**
- [ ] 24時間反応なし検知
- [ ] 自動キャンセル処理
- [ ] ポイント返却
- [ ] 通知送信

#### Week 5-6: ダッシュボード・分析

**ユーザーダッシュボード**
- [ ] アポイントメント履歴
- [ ] ポイント残高・取引履歴
- [ ] 統計情報（マッチング数、完了数等）

**分析機能**
- [ ] 利用状況可視化
- [ ] マッチング成功率
- [ ] ドタキャン率

**フィードバック**
- [ ] アポ後フィードバック機能
- [ ] 評価システム（5段階等）
- [ ] コメント機能

#### 成果物
- 自動化されたマッチング・通知システム
- ユーザーダッシュボード

---

### Phase 3: スケール対応（4-6週間）

#### 目標
本番環境で安定運用できるようにする

#### Week 1-2: パフォーマンス

**データベース最適化**
- [ ] インデックス追加
- [ ] クエリ最適化
- [ ] 接続プール設定

**キャッシュ**
- [ ] Redis導入検討
- [ ] 頻繁にアクセスするデータのキャッシュ
- [ ] Next.js ISR/SSG活用

**API最適化**
- [ ] 非同期処理の最適化
- [ ] バッチ処理の実装
- [ ] レスポンス時間改善

#### Week 3-4: モニタリング

**ログ**
- [ ] 構造化ログ実装
- [ ] ログ集約（将来的にDatadog等）

**エラー追跡**
- [ ] Sentry統合
- [ ] エラー通知設定

**パフォーマンス監視**
- [ ] Vercel Analytics設定
- [ ] カスタムメトリクス
- [ ] アラート設定

#### Week 5-6: セキュリティ・ドキュメント

**セキュリティ**
- [ ] 脆弱性スキャン
- [ ] セキュリティヘッダー設定
- [ ] データ暗号化確認
- [ ] 個人情報保護対応

**ドキュメント**
- [ ] APIドキュメント（OpenAPI/Swagger）
- [ ] 運用マニュアル
- [ ] トラブルシューティングガイド
- [ ] 開発者向けドキュメント

#### 成果物
- 本番環境で安定運用可能なシステム
- 運用ドキュメント一式

---

## リスク管理

### 高リスク項目

#### 1. WhatsApp Business API審査
**リスク**: 審査に時間がかかる、または却下される
**影響**: 通知機能がEmailのみになる
**対策**:
- 早期申請（Phase 0で開始）
- Email通知を必須機能として実装
- WhatsAppは補助機能として位置づけ

#### 2. カレンダーマッチングロジックの複雑さ
**リスク**: 想定以上に複雑で開発が遅延
**影響**: Phase 1の遅延
**対策**:
- プロトタイプを早期に作成
- シンプルなロジックから開始
- 段階的に改善

#### 3. Google Calendar API制限
**リスク**: レート制限に引っかかる
**影響**: スケーラビリティ問題
**対策**:
- レート制限対策（キャッシュ、バッチ処理）
- モニタリング実装
- 代替案検討（iCal等）

### 中リスク項目

#### 1. 決済統合の複雑さ
**対策**: Stripe公式ドキュメント参照、サンドボックスで十分検証

#### 2. ドタキャン防止UX
**対策**: ユーザーテスト実施、段階的改善

---

## 成功指標（KPI）

### Phase 1完了時
- ✅ ユーザー登録数: 10-20人（テストユーザー含む）
- ✅ マッチング成功率: 70%以上
- ✅ アポイントメント確定率: 60%以上
- ✅ システム稼働率: 95%以上

### Phase 2完了時
- ✅ アクティブユーザー: 50-100人
- ✅ 自動マッチング率: 80%以上
- ✅ ドタキャン率: 10%以下
- ✅ ユーザー満足度: 4.0/5.0以上

### Phase 3完了時
- ✅ アクティブユーザー: 200人以上
- ✅ システム稼働率: 99%以上
- ✅ 平均レスポンス時間: 500ms以下
- ✅ エラー率: 0.1%以下

---

## 次のステップ

### 即座に開始すべきこと
1. **外部API申請**
   - Google Cloud Console設定
   - Stripeアカウント作成
   - Twilio WhatsApp申請（審査に時間かかる）

2. **プロジェクト初期化**
   - GitHubリポジトリ作成
   - Next.jsプロジェクト作成
   - 開発環境構築

3. **設計開始**
   - データモデル設計
   - API設計
   - UI/UXワイヤーフレーム

### 1週間以内
- 設計書完成
- 開発環境構築完了
- 外部API申請完了（可能なもの）

### 1ヶ月以内
- Phase 1の基盤構築完了
- 認証・ユーザー管理実装完了

---

## 参考資料

### 技術ドキュメント
- [Next.js Documentation](https://nextjs.org/docs)
- [Google Calendar API](https://developers.google.com/calendar)
- [Stripe Documentation](https://stripe.com/docs)
- [Twilio WhatsApp API](https://www.twilio.com/docs/whatsapp)
- [NextAuth.js](https://next-auth.js.org/)

### デザイン参考
- Calendly（カレンダー予約）
- Tinder（マッチングUI）
- HelloTalk（言語交換）

---

## 更新履歴

- 2024-XX-XX: 初版作成

